{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block styles %}
<style>
    pre.log-entry {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.85rem;
        padding: 0.5rem;
        margin-bottom: 0.25rem;
        border-radius: 4px;
    }
    
    .log-level {
        display: inline-block;
        min-width: 60px;
        text-align: center;
        padding: 2px 4px;
        border-radius: 3px;
        margin-right: 5px;
        font-weight: bold;
    }
    
    .log-level-DEBUG { background-color: #e9ecef; color: #495057; }
    .log-level-INFO { background-color: #cfe2ff; color: #084298; }
    .log-level-WARNING { background-color: #fff3cd; color: #664d03; }
    .log-level-ERROR { background-color: #f8d7da; color: #842029; }
    .log-level-CRITICAL { background-color: #343a40; color: #ffffff; }
    
    .log-timestamp {
        color: #6c757d;
        margin-right: 5px;
    }
    
    .log-module {
        color: #212529;
        font-weight: 500;
    }
    
    .log-message {
        margin-top: 3px;
    }
    
    .log-json {
        margin-top: 8px;
        background-color: #f8f9fa;
        padding: 8px;
        border-radius: 4px;
        border-left: 3px solid #dee2e6;
    }
    
    .highlight {
        background-color: #fff59d;
        padding: 0 2px;
    }
    
    .log-controls {
        position: sticky;
        top: 56px;
        z-index: 100;
        background-color: rgba(255, 255, 255, 0.95);
        padding: 10px 0;
        border-bottom: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3">{{ title }}</h1>
        <div>
            <a href="{{ url_for('logs.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Terug naar overzicht
            </a>
            <a href="{{ url_for('logs.download_log', log_type=log_type) }}" class="btn btn-outline-primary ms-2">
                <i class="fas fa-download me-1"></i> Download
            </a>
        </div>
    </div>
    
    <div class="log-controls card mb-3">
        <div class="card-body pb-2">
            <form id="filterForm" method="get" class="row row-cols-lg-auto g-3 align-items-center">
                <div class="col-12">
                    <label class="visually-hidden" for="filterText">Filtertext</label>
                    <div class="input-group">
                        <div class="input-group-text"><i class="fas fa-search"></i></div>
                        <input type="text" class="form-control" id="filterText" name="filter" 
                               placeholder="Filteren..." value="{{ filter_text }}">
                    </div>
                </div>
                
                <div class="col-12">
                    <label class="visually-hidden" for="levelFilter">Log niveau</label>
                    <select class="form-select" id="levelFilter" name="level">
                        <option value="" {% if not level_filter %}selected{% endif %}>Alle niveaus</option>
                        <option value="DEBUG" {% if level_filter == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                        <option value="INFO" {% if level_filter == 'INFO' %}selected{% endif %}>INFO</option>
                        <option value="WARNING" {% if level_filter == 'WARNING' %}selected{% endif %}>WARNING</option>
                        <option value="ERROR" {% if level_filter == 'ERROR' %}selected{% endif %}>ERROR</option>
                        <option value="CRITICAL" {% if level_filter == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
                    </select>
                </div>
                
                <div class="col-12">
                    <label class="visually-hidden" for="linesPerPage">Regels per pagina</label>
                    <select class="form-select" id="linesPerPage" name="lines">
                        <option value="50" {% if lines_per_page == 50 %}selected{% endif %}>50 regels</option>
                        <option value="100" {% if lines_per_page == 100 %}selected{% endif %}>100 regels</option>
                        <option value="250" {% if lines_per_page == 250 %}selected{% endif %}>250 regels</option>
                        <option value="500" {% if lines_per_page == 500 %}selected{% endif %}>500 regels</option>
                    </select>
                </div>
                
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Toepassen</button>
                    <a href="{{ url_for('logs.view_log', log_type=log_type) }}" class="btn btn-outline-secondary ms-2">Reset</a>
                </div>
                
                <input type="hidden" name="page" id="pageInput" value="{{ current_page }}">
            </form>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Log Inhoud</h5>
                <span class="badge bg-secondary">{{ log_data|length }} regels weergegeven</span>
            </div>
        </div>
        <div class="card-body p-2">
            <div id="logContent">
                {% if log_type == 'json' %}
                    {% for entry in log_data %}
                    <div class="log-json mb-3">
                        <div class="d-flex align-items-center">
                            <span class="log-level log-level-{{ entry.level }}">{{ entry.level }}</span>
                            <span class="log-timestamp">{{ entry.timestamp }}</span>
                            {% if entry.logger %}
                            <span class="log-module">{{ entry.logger }}</span>
                            {% endif %}
                        </div>
                        <div class="log-message">{{ entry.message }}</div>
                        {% if entry.exception %}
                        <pre class="mt-2 text-danger">{{ entry.exception }}</pre>
                        {% endif %}
                        <div class="mt-2">
                            <small>
                                <strong>Module:</strong> {{ entry.module }} | <strong>Line:</strong> {{ entry.lineno }}
                                {% if entry.request_id %}| <strong>Request ID:</strong> {{ entry.request_id }}{% endif %}
                                {% if entry.user_id %}| <strong>User ID:</strong> {{ entry.user_id }}{% endif %}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    {% for line in log_data %}
                    <pre class="log-entry">{{ highlight_log_line(line, filter_text) }}</pre>
                    {% endfor %}
                {% endif %}
                
                {% if not log_data %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Geen loggegevens gevonden met de huidige filters.
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card-footer">
            <nav aria-label="Paginering">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item {% if current_page <= 1 %}disabled{% endif %}">
                        <a class="page-link" href="javascript:void(0)" onclick="navigateToPage({{ current_page - 1 }})" aria-label="Vorige">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    
                    {% if total_pages <= 10 %}
                        {% for p in range(1, total_pages + 1) %}
                        <li class="page-item {% if p == current_page %}active{% endif %}">
                            <a class="page-link" href="javascript:void(0)" onclick="navigateToPage({{ p }})">{{ p }}</a>
                        </li>
                        {% endfor %}
                    {% else %}
                        {% set start = [current_page - 2, 1]|max %}
                        {% set end = [start + 4, total_pages]|min %}
                        {% set start = [end - 4, 1]|max %}
                        
                        {% if start > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0)" onclick="navigateToPage(1)">1</a>
                        </li>
                        {% if start > 2 %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#">...</a>
                        </li>
                        {% endif %}
                        {% endif %}
                        
                        {% for p in range(start, end + 1) %}
                        <li class="page-item {% if p == current_page %}active{% endif %}">
                            <a class="page-link" href="javascript:void(0)" onclick="navigateToPage({{ p }})">{{ p }}</a>
                        </li>
                        {% endfor %}
                        
                        {% if end < total_pages %}
                        {% if end < total_pages - 1 %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#">...</a>
                        </li>
                        {% endif %}
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0)" onclick="navigateToPage({{ total_pages }})">{{ total_pages }}</a>
                        </li>
                        {% endif %}
                    {% endif %}
                    
                    <li class="page-item {% if current_page >= total_pages %}disabled{% endif %}">
                        <a class="page-link" href="javascript:void(0)" onclick="navigateToPage({{ current_page + 1 }})" aria-label="Volgende">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Functie voor paginering
    function navigateToPage(page) {
        document.getElementById('pageInput').value = page;
        document.getElementById('filterForm').submit();
    }
    
    // Automatisch verversen elke 30 seconden indien nodig
    document.addEventListener('DOMContentLoaded', function() {
        const autoRefreshCheckbox = document.getElementById('autoRefresh');
        
        if (autoRefreshCheckbox) {
            let refreshInterval;
            
            autoRefreshCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    refreshInterval = setInterval(function() {
                        location.reload();
                    }, 30000); // 30 seconden
                } else {
                    clearInterval(refreshInterval);
                }
            });
        }
    });
</script>
{% endblock %}

{% macro highlight_log_line(line, filter_text) %}
    {% if filter_text %}
        {{ line|replace(filter_text, '<span class="highlight">' + filter_text + '</span>')|safe }}
    {% else %}
        {{ line }}
    {% endif %}
{% endmacro %}